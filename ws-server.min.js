import{serve}from"bun";import chokidar from"chokidar";import fs from"fs";import path from"path";const connectedClients=new Set,sslOptions={key:fs.readFileSync(path.resolve("server.key")),cert:fs.readFileSync(path.resolve("server.cert"))};function broadcast(e){const t=JSON.stringify(e);for(const e of connectedClients)try{e.send(t)}catch(e){console.error("Error sending message:",e)}}serve({port:443,hostname:"0.0.0.0",key:sslOptions.key,cert:sslOptions.cert,async fetch(e,t){if("/dealeron-html-previewer.min.js"===new URL(e.url).pathname)try{const e=await fetch("https://izee.ai/js/dealeron-html-previewer.min.js",{});if(!e.ok)return new Response(`Error fetching script: ${e.statusText}`,{status:e.status});const t=await e.text();return new Response(t,{headers:{"Content-Type":"application/javascript"}})}catch(e){return console.error("Fetch error:",e),new Response("Internal Server Error",{status:500})}if(!t.upgrade(e))return new Response("Upgrade failed",{status:500})},websocket:{open(e){console.log("New client connected"),connectedClients.add(e),e.onclose=()=>{console.log("Client disconnected"),connectedClients.delete(e)}},message(e,t){console.log("Received message from client:",t)},close(e,t,n){console.log(`Client closed connection: ${t} ${n}`),connectedClients.delete(e)},drain(e){}}});const watcher=chokidar.watch("dealerships",{persistent:!0,ignoreInitial:!0});watcher.on("change",(e=>{broadcast({type:"file-changed",path:e})})),watcher.on("error",(e=>{console.error(`Watcher error: ${e}`)})),console.log("Bun server is listening for HTTPS and WebSocket connections on port 443...");